<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>MotorDeal Game</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: black;
      color: white;
      overflow: hidden;
      margin: 0;
      font-family: sans-serif;
      touch-action: none;
    }

    #gameContainer {
      position: relative;
      width: 100vw;
      height: 70vh;
      margin: auto;
      background-color: #222;
      border: 2px solid #FFD700;
      overflow: hidden;
    }

    #car {
      width: 40px;
      height: 60px;
      background-image: url('imagenes/auto.png');
      background-size: contain;
      background-repeat: no-repeat;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(180deg);
    }

    .coin {
      width: 30px;
      height: 30px;
      background-image: url('imagenes/moneda.png');
      background-size: contain;
      background-repeat: no-repeat;
      position: absolute;
    }

    #joystick {
      position: fixed;
      bottom: 20px;
      left: 20px;
      width: 100px;
      height: 100px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      display: none;
      justify-content: center;
      align-items: center;
    }

    #stick {
      width: 40px;
      height: 40px;
      background: #FFD700;
      border-radius: 50%;
      position: absolute;
    }

    @media (pointer: coarse) {
      #joystick {
        display: flex;
      }
    }
  </style>
</head>
<body>
  <div class="text-center mt-3">
    <h1 style="color: #FFD700">MotorDeal</h1>
    <p>Utiliza el joystick virtual para recoger las monedas</p>
  </div>
  <div id="gameContainer">
    <div id="car"></div>
  </div>
  <div class="text-center mt-3">
    <p>Visítanos en: <a href="https://motordeal.store/" target="_blank" style="color:#FFD700">https://motordeal.store/</a></p>
  </div>
  <div id="joystick">
    <div id="stick"></div>
  </div>

  <script>
    const car = document.getElementById("car");
    const container = document.getElementById("gameContainer");
    const joystick = document.getElementById("joystick");
    const stick = document.getElementById("stick");
    let x = container.clientWidth / 2;
    let y = container.clientHeight / 2;
    let dx = 0;
    let dy = 0;
    let speed = 2;
    let coinsCollected = 0;
    const totalCoins = 5;

    function rotateCar(dx, dy) {
      if (dx === 0 && dy === 0) return;
      const angle = Math.atan2(dy, dx) * (180 / Math.PI) + 90;
      car.style.transform = `translate(-50%, -50%) rotate(${angle}deg)`;
    }

    function spawnCoin() {
      const coin = document.createElement("div");
      coin.className = "coin";
      const padding = 40;
      coin.style.left = `${Math.random() * (container.clientWidth - padding * 2) + padding}px`;
      coin.style.top = `${Math.random() * (container.clientHeight - padding * 2) + padding}px`;
      container.appendChild(coin);
    }

    for (let i = 0; i < totalCoins; i++) spawnCoin();

    function update() {
      x += dx * speed;
      y += dy * speed;

      const maxX = container.clientWidth - car.clientWidth / 2;
      const maxY = container.clientHeight - car.clientHeight / 2;
      const minX = car.clientWidth / 2;
      const minY = car.clientHeight / 2;

      x = Math.max(minX, Math.min(maxX, x));
      y = Math.max(minY, Math.min(maxY, y));

      car.style.left = `${x}px`;
      car.style.top = `${y}px`;

      document.querySelectorAll(".coin").forEach(coin => {
        const rect1 = car.getBoundingClientRect();
        const rect2 = coin.getBoundingClientRect();
        const shrink = 0.5;
        if (
          rect1.left < rect2.right - rect2.width * (1 - shrink) &&
          rect1.right > rect2.left + rect2.width * (1 - shrink) &&
          rect1.top < rect2.bottom - rect2.height * (1 - shrink) &&
          rect1.bottom > rect2.top + rect2.height * (1 - shrink)
        ) {
          coin.remove();
          coinsCollected++;
          if (coinsCollected === totalCoins) {
            alert("¡Felicidades! Has recogido todas las monedas. Necesitamos tu voto para ganar el proyecto popular. ¡Báncanos porfa!");
            window.location.href = "https://www.facebook.com/share/171NxZ5iez/?mibextid=wwXIfr";
          }
        }
      });

      requestAnimationFrame(update);
    }

    update();

    document.addEventListener("keydown", e => {
      if (e.key === "ArrowUp" || e.key === "w") dy = -1;
      else if (e.key === "ArrowDown" || e.key === "s") dy = 1;
      else if (e.key === "ArrowLeft" || e.key === "a") dx = -1;
      else if (e.key === "ArrowRight" || e.key === "d") dx = 1;
      rotateCar(dx, dy);
    });

    document.addEventListener("keyup", e => {
      if (["ArrowUp", "ArrowDown", "w", "s"].includes(e.key)) dy = 0;
      if (["ArrowLeft", "ArrowRight", "a", "d"].includes(e.key)) dx = 0;
    });

    // Joystick
    let dragging = false;
    let joyCenterX, joyCenterY;

    joystick.addEventListener("touchstart", e => {
      dragging = true;
      joyCenterX = joystick.offsetLeft + joystick.offsetWidth / 2;
      joyCenterY = joystick.offsetTop + joystick.offsetHeight / 2;
    });

    joystick.addEventListener("touchmove", e => {
      if (!dragging) return;
      const touch = e.touches[0];
      const offsetX = touch.clientX - joyCenterX;
      const offsetY = touch.clientY - joyCenterY;
      const length = Math.min(Math.hypot(offsetX, offsetY), 40);
      const angle = Math.atan2(offsetY, offsetX);
      stick.style.left = `${40 + length * Math.cos(angle)}px`;
      stick.style.top = `${40 + length * Math.sin(angle)}px`;
      dx = Math.round(Math.cos(angle));
      dy = Math.round(Math.sin(angle));
      rotateCar(dx, dy);
    });

    joystick.addEventListener("touchend", e => {
      dragging = false;
      stick.style.left = `40px`;
      stick.style.top = `40px`;
      dx = 0;
      dy = 0;
    });
  </script>
</body>
</html>
